<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Training</title>

    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css">
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>


    <script src="libs/jquery-3.5.1.min.js"></script>
    <script src="jatos.js"></script>
    <script src="utils.js"></script>
    <script src="trials.js"></script>
    <link rel="stylesheet" href="libs/pure-release-0.6.0/pure-min.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css" />

    <script id="Variables">
        let showLog = false;
        let associationsPerBreak = 0;
        let botActive = false;
        let error_strike = 0;
        let words_list = [];
        let textInput_limit = 0;
        let textStart_limit = 0;
        let breakStates = []
        let assocIndex = 0;
        let enteredWord = ""; // Initialize the entered word
        let break_duration = 0;
    </script>

    <script id="Trials">
        function getQuestionsTrial() {
            return [createLikertTrial("To what extent do you identify with the following statement:<br><b>I enjoyed the game so far</b>","trainingQuestions")];
        }


        function displaysTrainingInstructionsTrial(text) {
            text = [
                'Welcome to the training session!',
                'In this part, you will learn how the game works and practice the tasks step by step.<br>Take your time to understand the instructions â€” this phase is designed to help you feel fully comfortable before the real game begins.',
                'When you feel ready, click NEXT to begin the training.'
            ];
            return {
                type: jsPsychInstructions,
                pages: text,
                show_clickable_nav: true,
                allow_keys: false
            }
        }
    </script>

    <script id="Experiment">
        let jsPsych = initJsPsych({
            on_finish: function () {
                jatos.startNextComponent(jsPsych.data.get().json() + jsPsych.data.getInteractionData().json());
            }
        });


        function onGroupSession(path, op) {
            try {
                if (path === LEAVED_PLAYERS_PROPERTY) {
                    console.log('[TRAINING] onGroupSession -> LEAVED changed (op=', op, '):', jatos.groupSession.get(LEAVED_PLAYERS_PROPERTY));
                }
            } catch (e) {
                console.error('[TRAINING] onGroupSession error:', e);
            }
        }

        function onMemberOpen(memberId) { }

        function onMemberClose(memberId) {
            if (showLog) console.log("Other Player close")
            onOtherPlayerDrop();
        }


        async function onMemberLeave(memberId) {
            console.log("Players status : ",jatos.groupSession.get(PLAYERS_METADATA_PROPERTY));
            if (getManagerID() === jatos.groupMemberId) {
                jatos.groupSession.set(PLAYERS_METADATA_PROPERTY + "." + id, botActive ? "bot" : "leaved")
                    .then(() => console.log("Updated metadata after member leave:", botActive ? "bot" : "leaved"))
                    .catch(e => console.log("Error updating metadata", e));
            }
        }

        function printError(errorMsg) {
            console.log(errorMsg);
        }

        // ===== Helper: read common inputs and session =====
        function initializeSessionVariables() {
            showLog = jatos.batchJsonInput.showLog || jatos.studyJsonInput.showLog || false;
            words_list = jatos.groupSession.get(TRAINING_WORDS_PROPERTY);
            break_duration = jatos.batchJsonInput.break_duration || jatos.studyJsonInput.break_duration || 15 * 1000
            textInput_limit = jatos.batchJsonInput.textInput_limit || jatos.studyJsonInput.textInput_limit || 10
            textStart_limit = jatos.batchJsonInput.textStart_limit || jatos.studyJsonInput.textStart_limit || 1.5
            associationsPerBreak = jatos.batchJsonInput.associationsPerBreak || jatos.studyJsonInput.associationsPerBreak || 10;
        }



        /*******************************************************
         * CHECK BREAK CONDITION BETWEEN ASSOCIATIONS
         * -----------------------------------------------------
         * We trigger a break when:
         *  - The number of associations so far (`assocIndex`)
         *    is a multiple of `associationsPerBreak`
         *  - The last sender is still active (not a leaver)
         *******************************************************/
        function checkBreak() {
            console.log("assoc index = ",assocIndex , " associationsPerBreak = ",associationsPerBreak);
            return assocIndex % associationsPerBreak === 0;
        }

        function updateAssociationState() {
            return {
                type: jsPsychCallFunction,
                func: () => {
                    assocIndex += 1;
                    console.log("updateAssociationState");
                }
            }
        }


        function onOpen() {
            initializeSessionVariables();

            let timeline = [];
            timeline.push(displaysTrainingInstructionsTrial());
            timeline.push(updateGroupSessionTrial([
                [jatos.groupMemberId + COMPLETE_TRAINING_EXTENTION, true]
            ]));
            timeline.push(getAllFinishParamTrial(COMPLETE_TRAINING_EXTENTION,"Please wait for the other players to finish the training part of the game"));

            jsPsych.run(timeline);

            // STEP 6: Add Prolific metadata
            jsPsych.data.addProperties({
                ProlificID: jatos.urlQueryParameters.PROLIFIC_PID,
                ProlificStudyID: jatos.urlQueryParameters.STUDY_ID,
                ProlificSessionID: jatos.urlQueryParameters.SESSION_ID
            });
        }

        jatos.onLoad(function () {
            jatos.joinGroup({
                "onOpen": onOpen,
                "onMemberOpen": onMemberOpen,
                "onGroupSession": onGroupSession,
                "onMemberClose": onMemberClose,
                "onMemberLeave": onMemberLeave,
                "onError": printError
            });
        });
    </script>

    </meta>
</head>