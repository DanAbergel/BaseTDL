<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Main</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-slider-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css">

    <script src="libs/jquery-3.5.1.min.js"></script>
    <script src="jatos.js"></script>
    <script src="utils.js"></script>
    <script src="trials.js"></script>
    <link rel="stylesheet" href="libs/pure-release-0.6.0/pure-min.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css" />


    <script id="Variables">
        const jsPsych = initJsPsych() ;
        let showLog = false;

        // BOT Variables
        let leavedPlayers = []
        let allPlayers = [];
        let botActive = false;
        let associationsPerBreak = 0;
        let words_list = [];
        let textInput_limit = 0;
        let textStart_limit = 0;
        let breakStates = []
        let assocIndex = 0;
        let enteredWord = ""; // Initialize the entered word
    </script>

    <script id="Synchronous_helpers">
        /*******************************************************
         * CHECK BREAK CONDITION BETWEEN ASSOCIATIONS
         * -----------------------------------------------------
         * We trigger a break when:
         *  - The number of associations so far (`assocIndex`)
         *    is a multiple of `associationsPerBreak`
         *  - The last sender is still active (not a leaver)
         *******************************************************/
        function checkBreak() {
            console.log("assocIndex = ",assocIndex , "associationsPerBreak = ",associationsPerBreak);
            return assocIndex % associationsPerBreak === 0;
        }



        function getQuestionsTrial() {
            /*******************************************************
            * QUESTIONNAIRE TRIALS BETWEEN ASSOCIATIONS
            * -----------------------------------------------------
            * Presents a short set of Likert-scale questions to the
            * participant. These questions assess:
            *   - Enjoyment of the game
            *   - Feeling of synchrony with each other participant
            *   - Likeability of each other participant
            *
            * The questions involving other players dynamically
            * display the other players' avatars, based on shuffled
            * ordering of participant IDs.
            *******************************************************/
            const ids = shuffle_seed(getOtherPlayersIds());
            const base = (text, id) =>
                function () {
                    return getScreen([
                    text + " <img src='" +
                    getAvatarById(id) +
                    "' style='width: 50px; height: 50px;'>"
                ]);
            };
            return [
            createLikertTrial("To what extent do you identify with the following statement:<br><b>I enjoy the game so far</b>", "enjoy"),
            createLikertTrial(base("To what extent do you identify with the following statement:<br><b>I feel in-sync with</b>", ids[0]), "sync_" + ids[0]),
            createLikertTrial(base("To what extent do you identify with the following statement:<br><b>I feel in-sync with</b>", ids[1]), "sync_" + ids[1]),
            createLikertTrial(base("To what extent do you identify with the following statement:<br><b>So far, I like</b>", ids[0]), "like_" + ids[0]),
            createLikertTrial(base("To what extent do you identify with the following statement:<br><b>So far, I like</b>", ids[1]), "like_" + ids[1])
        ];
    }
    </script>

    <script id="Helpers">
        function initializeSessionVariables() {
            // Retrieve players who have left the group session
            leavedPlayers = jatos.groupSession.get(LEAVED_PLAYERS_PROPERTY);
            // Retrieve all players in the group session
            allPlayers = jatos.groupSession.get(ALL_MEMBER_IDS_PROPERTY);

            // Load configuration data from JATOS, using batch-level settings by default, falling back to empty object if none provided
            const cfg_batch = jatos.batchJsonInput || {};
            const cfg_study = jatos.studyJsonInput || {};
            // Enable or disable detailed logging in the console (default: false)
            showLog = cfg_batch.showLog || cfg_study.showLog || false;
            associationsPerBreak = cfg_batch.associationsPerBreak || cfg_study.associationsPerBreak || 10;
            // Whether a bot should answer for absent players (default: false)
            botActive = cfg_batch.botActive || cfg_study.botActive || false;
            // Duration of the break between blocks (default: 15 seconds)
            break_duration = cfg_batch.break_duration || cfg_study.break_duration || 15 * 1000
            words_list = shuffle_seed( cfg_batch.words_list || cfg_study.words_list || [] );
            textInput_limit = jatos.batchJsonInput.textInput_limit || jatos.studyJsonInput.textInput_limit || 10
            textStart_limit = jatos.batchJsonInput.textStart_limit || jatos.studyJsonInput.textStart_limit || 1.5

            // ==========================================================
            // Structured debug logs
            // ==========================================================
            if (showLog) {
                console.groupCollapsed("%c[INITIALIZATION SUMMARY]", "color: #2e86de; font-weight: bold;");
                console.table({
                    "AssociationsPerBreak": associationsPerBreak,
                    "Break duration": break_duration,
                    "Bot active": botActive,
                    "All players": allPlayers ? allPlayers.join(", ") : "N/A",
                    "Leaved players": leavedPlayers ? leavedPlayers.join(", ") : "None",
                    "Words list": words_list ? words_list.join(", ") : "None",
                });
                console.groupEnd();
            }
        }

        function updateAssociationState(word) {
            return {
                type: jsPsychCallFunction,
                func: () => {
                    assocIndex += 1;
                    console.log("[UPDATE_ASSOC] assocIndex =", assocIndex, "| current_stimulus_word =", word);
                }
            }
        }

        function syncPlayers(word) {
            const stimulus = () => {
                let assocs = {};
                allPlayers.forEach(pid => {
                    const key = pid + "_" + word;
                    assocs[key] = jatos.groupSession.get(key) || "";
                });
                const stimulusDiv = getHtmlTag("div", "stimuli_word", "stimuli_word", word);
                const myValue = assocs[jatos.groupMemberId + "_" + word] || "";
                const myInput = getHtmlTag("input", "word_input", null, null, { value: myValue, disabled: true });
                return getScreen([stimulusDiv, myInput], false, true);
            };

            return getAllFinishParamTrial("_" + word, "", "*", true, 600, stimulus);
        }

        function updateGD_trial(word){
            return updateGroupSessionTrial(
                jatos.groupMemberId + '_' + word,
                () => {
                    const entered_word = jsPsych.data.get().last(2).values()[0]. entered_word || jsPsych.data.get().last(1).values()[0]. entered_word;
                    console.log("entered word = ",entered_word);
                    console.log("val = ",(entered_word === undefined || entered_word === null || entered_word === "") ? NO_RESPONSE : entered_word)
                    return (entered_word === undefined || entered_word === null || entered_word === "") ? NO_RESPONSE : entered_word;
                }
            );
        }
    </script>
    <script id="Experiment">
        function onOpen(){
            initializeSessionVariables();
            let timeline = [];
            // timeline.push(...manageFullScreenTrial());
            words_list.forEach(word => {
                timeline.push(updateAssociationState(word));
                timeline.push(getCountdownTrial(word));
                timeline.push(getWordExchangeTrial(word));
                timeline.push(updateGD_trial(word));
                timeline.push(syncPlayers(word));
                timeline.push(getDisplayAnswersTrial(word));
                timeline.push(break_condition());
            });

            jsPsych.run(timeline);

            // Add metadata to the jsPsych dataset
            jsPsych.data.addProperties({
                groupAllocation: jatos.groupSession.get(ALLOCATED_GROUP_PROPERTY),
                ProlificID: jatos.urlQueryParameters.PROLIFIC_PID,
                ProlificStudyID: jatos.urlQueryParameters.STUDY_ID,
                ProlificSessionID: jatos.urlQueryParameters.SESSION_ID
            });
        }
        function onClose(){}
        function onMemberOpen(id){}
        function onMemberClose(id){}
        function onMemberLeave(id){}
        function onGroupSession(path,op){}
        function printError(message){}

        jatos.onLoad(
            function () {
                jatos.joinGroup({
                    "onOpen": onOpen,
                    "onClose": onClose,
                    "onGroupSession": onGroupSession,
                    "onMemberOpen": onMemberOpen,
                    "onMemberClose": onMemberClose,
                    "onMemberLeave": onMemberLeave,
                    "onError": printError,
                });
          });
    </script>
</head>
</html>