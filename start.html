<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Start</title>

    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css">

    <script src="libs/jquery-3.5.1.min.js"></script>
    <script src="jatos.js"></script>
    <script src="utils.js"></script>
    <script src="trials.js"></script>
    <link rel="stylesheet" href="libs/pure-release-0.6.0/pure-min.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css" />

    <script id="Variables">
        let my_avatar;
        let my_random_avatar;
        let botActive;
        let showLog;

    </script>

    <script id="Functions">
        // Function to handle the avatar click event
        function onAvatarClick(avatar_name, avatars_options) {
            my_avatar_element = document.getElementById(avatar_name);
            my_avatar_element.style.border = "5px solid #4CAF50"; // Green border
            my_avatar = avatar_name;
            jatos.studySessionData["studyAvatar"] = my_avatar;
            // filtering out the selected avatar
            avatars_options = avatars_options.filter(avatar => avatar !== avatar_name);
            my_random_avatar = shuffle_seed(avatars_options, 1)[0];
            jsPsych.finishTrial();
        }


        function initializePlayersMetadata(properties) {
            console.log("!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
            const cfg_batch = jatos.batchJsonInput || {};
            const cfg_study = jatos.studyJsonInput || {};

            const expectedTotalPlayers =
                cfg_batch.expectedTotalPlayers ||
                cfg_study.expectedTotalPlayers ||
                null;

            // 1. all humans connected at the beginning are PRESENT
            const realPlayers = jatos.groupMembers || [];
            properties[HUMAN_PLAYERS_PROPERTY] = realPlayers;

            // 2. init bots for get expectedTotalPlayers
            if (expectedTotalPlayers !== null) {
                const botsNeeded = Math.max(
                    0,
                    expectedTotalPlayers - realPlayers.length
                );

                // Generate random position prefix based on group composition (same for all players)
                const groupSeed = realPlayers.sort().join('').split('').reduce((a, b) => a + b.charCodeAt(0), 0);

                properties[BOT_PLAYERS_PROPERTY] = []
                for (let i = 0; i < botsNeeded; i++) {
                    // Create bot ID with random-looking number to vary position among players
                    const botPosition = ((groupSeed + i * 1337) % 9000) + 1000;
                    const botId = `${botPosition}_BOT_${i + 1}`;
                    properties[BOT_PLAYERS_PROPERTY].push(botId);
                    // Assign different avatars for avatar and random_avatar
                    // Use avatars from the end of the list to avoid conflicts with human players
                    const avatarIndex = AVATARS_LIST.length - 1 - (i * 2);
                    const randomAvatarIndex = AVATARS_LIST.length - 2 - (i * 2);
                    properties[botId + AVATAR_EXTENSION] = AVATARS_LIST[avatarIndex];
                    properties[botId + RANDOM_AVATAR_EXTENSION] = AVATARS_LIST[randomAvatarIndex];
                }

                console.log(
                    "[GROUP INIT]",
                    "\npresent humans =", properties[HUMAN_PLAYERS_PROPERTY],
                    "\nbots = ",properties[BOT_PLAYERS_PROPERTY],
                    "\nexpectedTotalPlayers =", expectedTotalPlayers,
                    "\nbotsInitialized =", botsNeeded
                );
            }
        }

    </script>

    <script id="Trials">
        // Function to select the avatar
        function selectAvatarTrial() {
            const avatars_options = getAvailableAvatars(my_avatar);
            console.log("AVATAR options ====> ",avatars_options);
            return {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function () {
                    const choose_your_avatar = getHtmlTag(
                        "div",
                        "avatar_text",
                        "avatar_text",
                        "Choose your avatar"
                    );
                    const avatar_options_components = avatars_options.map(avatar_name => {
                        return getHtmlTag(
                            "img",
                            "avatar",
                            avatar_name,
                            null,
                            { src: getAvatarPath(avatar_name) }
                        );
                    });
                    return getHtmlTag(
                        "div",
                        null,
                        null,
                        [choose_your_avatar, ...avatar_options_components]
                    );
                },
                on_load: function () {
                    avatars_options.forEach(avatar_name => {
                        document
                            .getElementById(avatar_name)
                            .addEventListener("click", () =>
                                onAvatarClick(avatar_name, avatars_options)
                            );
                    });
                },
                choices: "NO_KEYS"
            };
        }
    </script>

    <script id="Experiment">
        let jsPsych = initJsPsych({
            on_finish: function () {
                jatos.startNextComponent(jsPsych.data.get().json());
            }
        });


        // Function to initialize all global variables shared across modules
        async function initializeGlobalVariables() {
            console.log("Initializing global experiment variables...");
            botActive = jatos.batchJsonInput.botActive || jatos.studyJsonInput.botActive || false;
            showLog = jatos.batchJsonInput.showLog || jatos.studyJsonInput.showLog || false;
            if (jatos.groupSession.get(HUMAN_PLAYERS_PROPERTY) === undefined) {
                //Make sure group allocation is initialized only once
                properties = jatos.groupSession.getAll();
                properties[ALLOCATED_GROUP_PROPERTY] = Math.floor(Math.random() * 3) + 1;
                const words_list = jatos.batchJsonInput.words_list || jatos.studyJsonInput.words_list || [];
                const num_splits = jatos.batchJsonInput.num_splits || jatos.studyJsonInput.num_splits || 20;
                const fraction_size = Math.ceil(words_list.length / num_splits);
                const shuffled_words_list = shuffle_seed(words_list);
                properties[TRAINING_WORDS_PROPERTY] = shuffled_words_list.slice(0, fraction_size);
                properties[MAIN_WORDS_PROPERTY] = shuffled_words_list.slice(fraction_size, 2 * fraction_size);

                initializePlayersMetadata(properties);

              await jatos.groupSession.setAll(properties);
                console.log("Group allocation initialized. Allocated group: " + jatos.groupSession.get(ALLOCATED_GROUP_PROPERTY));

            }
            console.log("Global variables initialized");
        }

        async function onOpen() {
            // Initialize global variables before anything else
            await initializeGlobalVariables();

            timeline = [];
            timeline.push(selectAvatarTrial())
            timeline.push(updateGroupSessionTrial([
                [jatos.groupMemberId + AVATAR_EXTENSION, ()=>{return my_avatar}],
                [jatos.groupMemberId + RANDOM_AVATAR_EXTENSION, ()=>{return my_random_avatar}],
            ]));
            jsPsych.run(timeline);

            jsPsych.data.addProperties({
                ProlificID: jatos.urlQueryParameters.PROLIFIC_PID,
                ProlificStudyID: jatos.urlQueryParameters.STUDY_ID,
                ProlificSessionID: jatos.urlQueryParameters.SESSION_ID
            });
        }

        function onMemberLeave(id) {
            updateRandomAvatar(id);
        }

        jatos.onLoad(function () {
            jatos.joinGroup({
                "onOpen": onOpen,
                "onMemberLeave": onMemberLeave,
            });
            jatos.setGroupFixed();
        });
    </script>

    </meta>
</head></html>