<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Start</title>

    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
    <script src="https://unpkg.com/@jspsych/plugin-call-function@1.1.3"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css">

    <script src="libs/jquery-3.5.1.min.js"></script>
    <script src="jatos.js"></script>
    <script src="utils.js"></script>
    <link rel="stylesheet" href="libs/pure-release-0.6.0/pure-min.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css" />

    <script id="Constants">
        const AVATARS_LIST = [
            "bear",
            "cat",
            "chicken",
            "deer",
            "dog_1",
            "dog_2",
            "elephant",
            "frog",
            "lion",
            "monkey",
            "panda",
            "seal",
            "tiger",
            "turtle"
        ]
    </script>

    <script id="Variables">
        let my_avatar;
        let my_random_avatar;
        let botActive;
        let showLog;
    </script>

    <script id="Functions">
        // Function to handle the avatar click event
        function onAvatarClick(avatar_name, avatars_options) {
            my_avatar_element = document.getElementById(avatar_name);
            my_avatar_element.style.border = "5px solid #4CAF50"; // Green border
            my_avatar = avatar_name;
            jatos.studySessionData["studyAvatar"] = my_avatar;
            // filtering out the selected avatar
            avatars_options = avatars_options.filter(avatar => avatar !== avatar_name);
            my_random_avatar = shuffle_seed(avatars_options, 1)[0];
            jsPsych.finishTrial();
        }
    </script>

    <script id="Trials">
        // Function to shuffle with a fixed seed
        function shuffle_seed(array, seed) {
            let currentIndex = array.length, temporaryValue, randomIndex;
            seed = seed || 1;
            let random = function () {
                var x = Math.sin(seed++) * 10000;
                return x - Math.floor(x);
            };
            // While there remain elements to shuffle...
            while (0 !== currentIndex) {
                // Pick a remaining element...
                randomIndex = Math.floor(random() * currentIndex);
                currentIndex -= 1;
                // And swap it with the current element.
                temporaryValue = array[currentIndex];
                array[currentIndex] = array[randomIndex];
                array[randomIndex] = temporaryValue;
            }
            return array;
        }

        // Function to select the avatar
        function selectAvatarTrial() {
            const avatars_options = jatos.groupMemberId === jatos.groupMembers[0] ? AVATARS_LIST.slice(0, 4) : jatos.groupMemberId == jatos.groupMembers[1] ? AVATARS_LIST.slice(5, 9) : AVATARS_LIST.slice(10, 14);
            return {
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function () {
                    const choose_your_avatar = getHtmlTag("div", "avatar_text", "avatar_text", "Choose your avatar");
                    const avatar_options_components = avatars_options.map(avatar_name => {
                        return getHtmlTag("img", "avatar", avatar_name, null, { src: getAvatarPath(avatar_name) })
                    });
                    return getHtmlTag("div", null, null, [choose_your_avatar, ...avatar_options_components])
                },
                on_load: function () {
                    avatars_options.forEach(avatar_name => {
                        document.getElementById(avatar_name).addEventListener("click", () => onAvatarClick(avatar_name, avatars_options));
                    });
                },
                choices: "NO_KEYS"
            };
        }

        function updateAvatarTrial() {
            return {
                type: jsPsychCallFunction,
                async: true,
                func: async function () {
                    await jatos.groupSession.set(jatos.groupMemberId + AVATAR_EXTENSION, my_avatar)
                        .then(() => { console.log("Avatar updated successfully"); jsPsych.finishTrial(); })
                        .catch((e) => {
                            setTimeout(() => {
                                jatos.groupSession.set(jatos.groupMemberId + AVATAR_EXTENSION, my_avatar)
                                    .then(() => { console.log("Avatar updated successfully (2nd attempt)"); jsPsych.finishTrial(); })
                                    .catch((e) => { console.log("Error updating avatar", e); jsPsych.finishTrial(); })
                            }, Math.random() * 1000);
                        })
                }
            }
        }

        function updateRandomAvatarTrial() {
            return {
                type: jsPsychCallFunction,
                async: true,
                func: async function () {
                    await jatos.groupSession.set(jatos.groupMemberId + RANDOM_AVATAR_EXTENSION, my_random_avatar)// my_random_avatar)
                        .then(() => { console.log("Random avatar updated successfully"); jsPsych.finishTrial(); })
                        .catch((e) => {
                            setTimeout(() => {
                                jatos.groupSession.set(jatos.groupMemberId + RANDOM_AVATAR_EXTENSION, my_random_avatar)
                                    .then(() => { console.log("Avatar updated successfully (2nd attempt)"); jsPsych.finishTrial(); })
                                    .catch((e) => { console.log("Error updating avatar", e); jsPsych.finishTrial(); })
                            }, Math.random() * 1000);
                        })
                }
            }
        }

    </script>

    <script id="Experiment">
        let jsPsych = initJsPsych({
            on_finish: function () {
                jatos.startNextComponent(jsPsych.data.get().json());
            }
        });



        // Function to initialize all global variables shared across modules
        function initializeGlobalVariables() {
            console.log("Initializing global experiment variables...");
            botActive = jatos.batchJsonInput.botActive || jatos.studyJsonInput.botActive || false;
            showLog = jatos.batchJsonInput.showLog || jatos.studyJsonInput.showLog || false;
            console.log("Global variables initialized");
        }

        function onOpen() {
            // Initialize global variables before anything else
            initializeGlobalVariables();
            // Retrieve current group session properties before modification
            if (jatos.groupMemberId === getManagerID()) {  //Make sure group allocation is initialized only once
                properties = jatos.groupSession.getAll();
                properties[ALLOCATED_GROUP_PROPERTY] = Math.floor(Math.random() * 3) + 1;
                const words_list = jatos.batchJsonInput.words_list || jatos.studyJsonInput.words_list || [];
                const num_splits = jatos.batchJsonInput.num_splits || jatos.studyJsonInput.num_splits || 2;

                // Compute size of each fraction
                const fraction_size = Math.ceil(words_list.length / num_splits);

                properties[TRAINING_WORDS_PROPERTY] = words_list.slice(0, fraction_size);
                properties[MAIN_WORDS_PROPERTY] = words_list.slice(fraction_size, 2 * fraction_size);

                properties[PLAYERS_METADATA_PROPERTY] = Object.fromEntries(
                    jatos.groupMembers.map(id => [id, "present"])
                );
                jatos.groupSession.setAll(properties)
                    .then(() => { console.log("Group allocation initialized" + jatos.groupSession.get(ALLOCATED_GROUP_PROPERTY))})
            }

            timeline = [];
            timeline.push(selectAvatarTrial())
            timeline.push(updateAvatarTrial())
            timeline.push(updateRandomAvatarTrial())
            jsPsych.run(timeline);

            jsPsych.data.addProperties({
                ProlificID: jatos.urlQueryParameters.PROLIFIC_PID,
                ProlificStudyID: jatos.urlQueryParameters.STUDY_ID,
                ProlificSessionID: jatos.urlQueryParameters.SESSION_ID
            });
        }

        function onMemberLeave(id) {
            if (getManagerID() === jatos.groupMemberId) {
                let props = jatos.groupSession.getAll();
                props[PLAYERS_METADATA_PROPERTY][id] = botActive ? "bot" : "leaved";
                jatos.groupSession.setAll(props)
                    .then(() => console.log("Updated metadata after member leave:",props[PLAYERS_METADATA_PROPERTY][id] ))
                    .catch(e => console.log("Error updating metadata", e));
            }
        }

        jatos.onLoad(function () {
            jatos.joinGroup({
                "onOpen": onOpen,
                "onMemberLeave": onMemberLeave,
            });
            jatos.setGroupFixed();
        });
    </script>

    </meta>
</head></html>